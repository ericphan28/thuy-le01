/**
 * Customer Statistics Analyzer - Xu√¢n Th√πy Pet Pharmacy
 * Ph√¢n t√≠ch th·ªëng k√™ chi ti·∫øt kh√°ch h√†ng t·ª´ Supabase database
 */

import { createClient } from '@supabase/supabase-js'
import { readFileSync, writeFileSync } from 'fs'
import { mkdirSync, existsSync } from 'fs'
import path from 'path'

interface Customer {
  customer_id: number
  customer_code: string
  customer_name: string
  customer_type_id: number
  branch_created_id: number
  phone?: string
  email?: string
  address?: string
  company_name?: string
  tax_code?: string
  id_number?: string
  gender?: string
  debt_limit: number
  current_debt: number
  total_revenue: number
  total_profit: number
  purchase_count: number
  last_purchase_date?: string
  status: number
  notes?: string
  created_by: string
  is_active: boolean
  created_at: string
  updated_at: string
}

interface CustomerType {
  type_id: number
  type_code: string
  type_name: string
  description: string
  is_active: boolean
  created_at: string
}

interface CustomerStats {
  totalCustomers: number
  activeCustomers: number
  inactiveCustomers: number
  totalRevenue: number
  averageRevenue: number
  medianRevenue: number
  maxRevenue: number
  minRevenue: number
  totalDebt: number
  averageDebt: number
  customersWithDebt: number
  debtViolations: number
  dataQuality: {
    phoneCompleteness: number
    emailCompleteness: number
    addressCompleteness: number
    genderCompleteness: number
  }
  demographics: {
    genderDistribution: Record<string, number>
    typeDistribution: Record<string, number>
    branchDistribution: Record<string, number>
    createdByDistribution: Record<string, number>
  }
  revenueSegments: {
    noRevenue: number
    lowRevenue: number      // < 1M
    mediumRevenue: number   // 1M - 10M
    highRevenue: number     // 10M - 50M
    vipRevenue: number      // > 50M
  }
  monthlyTrends: {
    newCustomersLast30Days: number
    newCustomersLast90Days: number
    newCustomersLast365Days: number
  }
  topCustomers: Array<{
    customer_id: number
    customer_code: string
    customer_name: string
    total_revenue: number
    customer_type: string
    purchase_count: number
  }>
}

function loadEnvFile(): Record<string, string> {
  try {
    const envContent = readFileSync('.env.local', 'utf8')
    console.log('üìÑ .env.local content length:', envContent.length)
    
    const envVars: Record<string, string> = {}
    
    envContent.split('\n').forEach((line, index) => {
      const trimmedLine = line.trim()
      if (trimmedLine && !trimmedLine.startsWith('#')) {
        const equalIndex = trimmedLine.indexOf('=')
        if (equalIndex > 0) {
          const key = trimmedLine.substring(0, equalIndex).trim()
          const value = trimmedLine.substring(equalIndex + 1).trim()
          if (key && value) {
            envVars[key] = value
            console.log(`   Line ${index + 1}: ${key} = ${value.substring(0, 20)}...`)
          }
        }
      }
    })
    
    console.log('üîë Successfully loaded env keys:', Object.keys(envVars))
    return envVars
  } catch (error) {
    console.error('‚ùå Could not load .env.local file:', error)
    return {}
  }
}

class CustomerStatsAnalyzer {
  private supabase: ReturnType<typeof createClient>
  private customers: Customer[] = []
  private customerTypes: CustomerType[] = []

  constructor() {
    // Load environment variables
    const envVars = loadEnvFile()
    const supabaseUrl = envVars.NEXT_PUBLIC_SUPABASE_URL
    const supabaseKey = envVars.NEXT_PUBLIC_SUPABASE_SERVICE_ROLE_KEY || envVars.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY || envVars.NEXT_PUBLIC_SUPABASE_ANON_KEY

    console.log('üîç Environment check:')
    console.log(`   URL: ${supabaseUrl || 'NOT SET'}`)
    console.log(`   KEY: ${supabaseKey ? `${supabaseKey.substring(0, 20)}...` : 'NOT SET'}`)
    console.log(`   Using: ${envVars.NEXT_PUBLIC_SUPABASE_SERVICE_ROLE_KEY ? 'SERVICE_ROLE_KEY' : 'PUBLISHABLE_OR_ANON_KEY'}`)

    if (!supabaseUrl || !supabaseKey) {
      console.error('Available env vars:', Object.keys(envVars))
      throw new Error('Missing Supabase configuration in .env.local')
    }

    this.supabase = createClient(supabaseUrl, supabaseKey)
    
    console.log('üöÄ Customer Statistics Analyzer kh·ªüi t·∫°o th√†nh c√¥ng!')
    console.log(`üìÖ Ng√†y ph√¢n t√≠ch: ${new Date().toLocaleString('vi-VN')}`)
    console.log('=' .repeat(80))
  }

  /**
   * L·∫•y t·∫•t c·∫£ d·ªØ li·ªáu c·∫ßn thi·∫øt t·ª´ Supabase
   */
  async fetchData(): Promise<void> {
    console.log('\nüìä ƒêang l·∫•y d·ªØ li·ªáu t·ª´ Supabase...')

    try {
      // L·∫•y customer types
      console.log('üè∑Ô∏è  L·∫•y customer types...')
      const { data: typesData, error: typesError } = await this.supabase
        .from('customer_types')
        .select('*')
        .order('type_id')

      if (typesError) {
        console.warn('‚ö†Ô∏è  Kh√¥ng th·ªÉ l·∫•y customer_types:', typesError.message)
        this.customerTypes = []
      } else {
        this.customerTypes = (typesData || []) as unknown as CustomerType[]
        console.log(`‚úÖ ƒê√£ l·∫•y ${this.customerTypes.length} lo·∫°i kh√°ch h√†ng`)
      }

      // L·∫•y t·∫•t c·∫£ customers
      console.log('üë• L·∫•y d·ªØ li·ªáu customers...')
      const { data: customersData, error: customersError } = await this.supabase
        .from('customers')
        .select('*')
        .order('customer_id')

      if (customersError) {
        throw new Error(`L·ªói khi l·∫•y customers: ${customersError.message}`)
      }

      this.customers = (customersData || []) as unknown as Customer[]
      console.log(`‚úÖ ƒê√£ l·∫•y ${this.customers.length} kh√°ch h√†ng`)

      if (this.customers.length === 0) {
        console.warn('‚ö†Ô∏è  Kh√¥ng c√≥ d·ªØ li·ªáu kh√°ch h√†ng trong database!')
        return
      }

      // Hi·ªÉn th·ªã sample data
      console.log('\nüîç Sample d·ªØ li·ªáu (5 kh√°ch h√†ng ƒë·∫ßu):')
      this.customers.slice(0, 5).forEach((customer, index) => {
        console.log(`   ${index + 1}. ${customer.customer_name || 'N/A'} (${customer.customer_code || 'N/A'})`)
        console.log(`      üí∞ Doanh thu: ${(customer.total_revenue || 0).toLocaleString('vi-VN')} VND`)
        console.log(`      üìû SƒêT: ${customer.phone || 'N/A'} | üìß Email: ${customer.email || 'N/A'}`)
      })

    } catch (error) {
      console.error('‚ùå L·ªói khi l·∫•y d·ªØ li·ªáu:', error)
      throw error
    }
  }

  /**
   * T√≠nh to√°n c√°c th·ªëng k√™ chi ti·∫øt
   */
  calculateStats(): CustomerStats {
    console.log('\nüìà B·∫Øt ƒë·∫ßu t√≠nh to√°n th·ªëng k√™...')

    if (this.customers.length === 0) {
      throw new Error('Kh√¥ng c√≥ d·ªØ li·ªáu kh√°ch h√†ng ƒë·ªÉ ph√¢n t√≠ch')
    }

    // 1. Th·ªëng k√™ c∆° b·∫£n
    console.log('1Ô∏è‚É£ Th·ªëng k√™ c∆° b·∫£n...')
    const totalCustomers = this.customers.length
    const activeCustomers = this.customers.filter(c => c.is_active).length
    const inactiveCustomers = totalCustomers - activeCustomers

    // 2. Th·ªëng k√™ doanh thu
    console.log('2Ô∏è‚É£ Th·ªëng k√™ doanh thu...')
    const revenues = this.customers.map(c => c.total_revenue || 0).sort((a, b) => a - b)
    const totalRevenue = revenues.reduce((sum, rev) => sum + rev, 0)
    const averageRevenue = revenues.length > 0 ? totalRevenue / revenues.length : 0
    const medianRevenue = revenues.length > 0 ? revenues[Math.floor(revenues.length / 2)] : 0
    const maxRevenue = revenues.length > 0 ? Math.max(...revenues) : 0
    const minRevenue = revenues.length > 0 ? Math.min(...revenues) : 0

    // 3. Th·ªëng k√™ c√¥ng n·ª£
    console.log('3Ô∏è‚É£ Th·ªëng k√™ c√¥ng n·ª£...')
    const debts = this.customers.map(c => c.current_debt || 0)
    const totalDebt = debts.reduce((sum, debt) => sum + debt, 0)
    const customersWithDebt = this.customers.filter(c => (c.current_debt || 0) > 0).length
    const averageDebt = customersWithDebt > 0 ? totalDebt / customersWithDebt : 0
    const debtViolations = this.customers.filter(c => 
      (c.current_debt || 0) > (c.debt_limit || 0) && (c.debt_limit || 0) > 0
    ).length

    // 4. Ch·∫•t l∆∞·ª£ng d·ªØ li·ªáu
    console.log('4Ô∏è‚É£ ƒê√°nh gi√° ch·∫•t l∆∞·ª£ng d·ªØ li·ªáu...')
    const phoneCompleteness = (this.customers.filter(c => c.phone && c.phone.trim()).length / totalCustomers) * 100
    const emailCompleteness = (this.customers.filter(c => c.email && c.email.trim()).length / totalCustomers) * 100
    const addressCompleteness = (this.customers.filter(c => c.address && c.address.trim()).length / totalCustomers) * 100
    const genderCompleteness = (this.customers.filter(c => c.gender && c.gender.trim()).length / totalCustomers) * 100

    // 5. Ph√¢n b·ªë nh√¢n kh·∫©u h·ªçc
    console.log('5Ô∏è‚É£ Ph√¢n t√≠ch nh√¢n kh·∫©u h·ªçc...')
    
    // Gender distribution
    const genderDistribution: Record<string, number> = {}
    this.customers.forEach(c => {
      const gender = c.gender || 'Kh√¥ng x√°c ƒë·ªãnh'
      genderDistribution[gender] = (genderDistribution[gender] || 0) + 1
    })

    // Type distribution
    const typeDistribution: Record<string, number> = {}
    this.customers.forEach(c => {
      const type = this.customerTypes.find(t => t.type_id === c.customer_type_id)
      const typeName = type ? type.type_name : `Type ${c.customer_type_id}`
      typeDistribution[typeName] = (typeDistribution[typeName] || 0) + 1
    })

    // Branch distribution
    const branchDistribution: Record<string, number> = {}
    this.customers.forEach(c => {
      const branch = `Chi nh√°nh ${c.branch_created_id || 'Unknown'}`
      branchDistribution[branch] = (branchDistribution[branch] || 0) + 1
    })

    // Created by distribution
    const createdByDistribution: Record<string, number> = {}
    this.customers.forEach(c => {
      const creator = c.created_by || 'Unknown'
      createdByDistribution[creator] = (createdByDistribution[creator] || 0) + 1
    })

    // 6. Ph√¢n kh√∫c doanh thu
    console.log('6Ô∏è‚É£ Ph√¢n kh√∫c doanh thu...')
    const revenueSegments = {
      noRevenue: this.customers.filter(c => (c.total_revenue || 0) === 0).length,
      lowRevenue: this.customers.filter(c => (c.total_revenue || 0) > 0 && (c.total_revenue || 0) < 1000000).length,
      mediumRevenue: this.customers.filter(c => (c.total_revenue || 0) >= 1000000 && (c.total_revenue || 0) < 10000000).length,
      highRevenue: this.customers.filter(c => (c.total_revenue || 0) >= 10000000 && (c.total_revenue || 0) < 50000000).length,
      vipRevenue: this.customers.filter(c => (c.total_revenue || 0) >= 50000000).length
    }

    // 7. Xu h∆∞·ªõng theo th·ªùi gian
    console.log('7Ô∏è‚É£ Xu h∆∞·ªõng th·ªùi gian...')
    const now = new Date()
    const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000))
    const ninetyDaysAgo = new Date(now.getTime() - (90 * 24 * 60 * 60 * 1000))
    const oneYearAgo = new Date(now.getTime() - (365 * 24 * 60 * 60 * 1000))

    const newCustomersLast30Days = this.customers.filter(c => 
      new Date(c.created_at) >= thirtyDaysAgo
    ).length
    const newCustomersLast90Days = this.customers.filter(c => 
      new Date(c.created_at) >= ninetyDaysAgo
    ).length
    const newCustomersLast365Days = this.customers.filter(c => 
      new Date(c.created_at) >= oneYearAgo
    ).length

    // 8. Top customers
    console.log('8Ô∏è‚É£ Top kh√°ch h√†ng...')
    const topCustomers = this.customers
      .filter(c => (c.total_revenue || 0) > 0)
      .sort((a, b) => (b.total_revenue || 0) - (a.total_revenue || 0))
      .slice(0, 20)
      .map(c => ({
        customer_id: c.customer_id,
        customer_code: c.customer_code || '',
        customer_name: c.customer_name || '',
        total_revenue: c.total_revenue || 0,
        customer_type: this.customerTypes.find(t => t.type_id === c.customer_type_id)?.type_name || 'Unknown',
        purchase_count: c.purchase_count || 0
      }))

    return {
      totalCustomers,
      activeCustomers,
      inactiveCustomers,
      totalRevenue,
      averageRevenue,
      medianRevenue,
      maxRevenue,
      minRevenue,
      totalDebt,
      averageDebt,
      customersWithDebt,
      debtViolations,
      dataQuality: {
        phoneCompleteness,
        emailCompleteness,
        addressCompleteness,
        genderCompleteness
      },
      demographics: {
        genderDistribution,
        typeDistribution,
        branchDistribution,
        createdByDistribution
      },
      revenueSegments,
      monthlyTrends: {
        newCustomersLast30Days,
        newCustomersLast90Days,
        newCustomersLast365Days
      },
      topCustomers
    }
  }

  /**
   * Hi·ªÉn th·ªã k·∫øt qu·∫£ th·ªëng k√™
   */
  displayStats(stats: CustomerStats): void {
    console.log('\n' + '=' .repeat(80))
    console.log('üìä K·∫æT QU·∫¢ PH√ÇN T√çCH TH·ªêNG K√ä KH√ÅCH H√ÄNG')
    console.log('=' .repeat(80))

    // 1. T·ªïng quan
    console.log('\n1Ô∏è‚É£ T·ªîNG QUAN:')
    console.log(`   üìã T·ªïng s·ªë kh√°ch h√†ng: ${stats.totalCustomers.toLocaleString('vi-VN')}`)
    console.log(`   ‚úÖ ƒêang ho·∫°t ƒë·ªông: ${stats.activeCustomers.toLocaleString('vi-VN')} (${(stats.activeCustomers/stats.totalCustomers*100).toFixed(1)}%)`)
    console.log(`   ‚ùå Kh√¥ng ho·∫°t ƒë·ªông: ${stats.inactiveCustomers.toLocaleString('vi-VN')} (${(stats.inactiveCustomers/stats.totalCustomers*100).toFixed(1)}%)`)

    // 2. Doanh thu
    console.log('\n2Ô∏è‚É£ DOANH THU:')
    console.log(`   üí∞ T·ªïng doanh thu: ${Math.round(stats.totalRevenue).toLocaleString('vi-VN')} VND`)
    console.log(`   üìä Doanh thu trung b√¨nh: ${Math.round(stats.averageRevenue).toLocaleString('vi-VN')} VND`)
    console.log(`   üìà Doanh thu trung v·ªã: ${Math.round(stats.medianRevenue).toLocaleString('vi-VN')} VND`)
    console.log(`   üèÜ Doanh thu cao nh·∫•t: ${Math.round(stats.maxRevenue).toLocaleString('vi-VN')} VND`)
    console.log(`   üìâ Doanh thu th·∫•p nh·∫•t: ${Math.round(stats.minRevenue).toLocaleString('vi-VN')} VND`)

    // 3. C√¥ng n·ª£
    console.log('\n3Ô∏è‚É£ C√îNG N·ª¢:')
    console.log(`   üí∏ T·ªïng c√¥ng n·ª£: ${Math.round(stats.totalDebt).toLocaleString('vi-VN')} VND`)
    console.log(`   üìä S·ªë KH c√≥ c√¥ng n·ª£: ${stats.customersWithDebt.toLocaleString('vi-VN')} (${(stats.customersWithDebt/stats.totalCustomers*100).toFixed(1)}%)`)
    console.log(`   üìà C√¥ng n·ª£ trung b√¨nh: ${Math.round(stats.averageDebt).toLocaleString('vi-VN')} VND`)
    if (stats.debtViolations > 0) {
      console.log(`   ‚ö†Ô∏è  Vi ph·∫°m h·∫°n m·ª©c: ${stats.debtViolations} kh√°ch h√†ng`)
    }

    // 4. Ch·∫•t l∆∞·ª£ng d·ªØ li·ªáu
    console.log('\n4Ô∏è‚É£ CH·∫§T L∆Ø·ª¢NG D·ªÆ LI·ªÜU:')
    const getQualityIcon = (percentage: number) => percentage > 80 ? 'üü¢' : percentage > 50 ? 'üü°' : 'üî¥'
    console.log(`   üìû ƒêi·ªán tho·∫°i: ${stats.dataQuality.phoneCompleteness.toFixed(1)}% ${getQualityIcon(stats.dataQuality.phoneCompleteness)}`)
    console.log(`   üìß Email: ${stats.dataQuality.emailCompleteness.toFixed(1)}% ${getQualityIcon(stats.dataQuality.emailCompleteness)}`)
    console.log(`   üè† ƒê·ªãa ch·ªâ: ${stats.dataQuality.addressCompleteness.toFixed(1)}% ${getQualityIcon(stats.dataQuality.addressCompleteness)}`)
    console.log(`   üë§ Gi·ªõi t√≠nh: ${stats.dataQuality.genderCompleteness.toFixed(1)}% ${getQualityIcon(stats.dataQuality.genderCompleteness)}`)

    // 5. Ph√¢n kh√∫c doanh thu
    console.log('\n5Ô∏è‚É£ PH√ÇN KH√öC DOANH THU:')
    console.log(`   üö´ Kh√¥ng c√≥ doanh thu: ${stats.revenueSegments.noRevenue.toLocaleString('vi-VN')} (${(stats.revenueSegments.noRevenue/stats.totalCustomers*100).toFixed(1)}%)`)
    console.log(`   ü•â Th·∫•p (<1M): ${stats.revenueSegments.lowRevenue.toLocaleString('vi-VN')} (${(stats.revenueSegments.lowRevenue/stats.totalCustomers*100).toFixed(1)}%)`)
    console.log(`   ü•à Trung b√¨nh (1M-10M): ${stats.revenueSegments.mediumRevenue.toLocaleString('vi-VN')} (${(stats.revenueSegments.mediumRevenue/stats.totalCustomers*100).toFixed(1)}%)`)
    console.log(`   ü•á Cao (10M-50M): ${stats.revenueSegments.highRevenue.toLocaleString('vi-VN')} (${(stats.revenueSegments.highRevenue/stats.totalCustomers*100).toFixed(1)}%)`)
    console.log(`   üíé VIP (>50M): ${stats.revenueSegments.vipRevenue.toLocaleString('vi-VN')} (${(stats.revenueSegments.vipRevenue/stats.totalCustomers*100).toFixed(1)}%)`)

    // 6. Xu h∆∞·ªõng th·ªùi gian
    console.log('\n6Ô∏è‚É£ XU H∆Ø·ªöNG TH·ªúI GIAN:')
    console.log(`   üìÖ KH m·ªõi 30 ng√†y: ${stats.monthlyTrends.newCustomersLast30Days.toLocaleString('vi-VN')}`)
    console.log(`   üìÖ KH m·ªõi 90 ng√†y: ${stats.monthlyTrends.newCustomersLast90Days.toLocaleString('vi-VN')}`)
    console.log(`   üìÖ KH m·ªõi 1 nƒÉm: ${stats.monthlyTrends.newCustomersLast365Days.toLocaleString('vi-VN')}`)

    // 7. Top 10 kh√°ch h√†ng
    console.log('\n7Ô∏è‚É£ TOP 10 KH√ÅCH H√ÄNG THEO DOANH THU:')
    stats.topCustomers.slice(0, 10).forEach((customer, index) => {
      console.log(`   ${(index + 1).toString().padStart(2, ' ')}. ${customer.customer_name} (${customer.customer_code})`)
      console.log(`       üí∞ ${customer.total_revenue.toLocaleString('vi-VN')} VND | üõí ${customer.purchase_count} ƒë∆°n | üè∑Ô∏è  ${customer.customer_type}`)
    })

    // 8. Ph√¢n b·ªë gi·ªõi t√≠nh (top 5)
    console.log('\n8Ô∏è‚É£ PH√ÇN B·ªê GI·ªöI T√çNH:')
    Object.entries(stats.demographics.genderDistribution)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5)
      .forEach(([gender, count]) => {
        const percentage = (count / stats.totalCustomers * 100).toFixed(1)
        console.log(`   üë§ ${gender}: ${count.toLocaleString('vi-VN')} (${percentage}%)`)
      })

    // 9. Ph√¢n b·ªë lo·∫°i kh√°ch h√†ng
    console.log('\n9Ô∏è‚É£ PH√ÇN B·ªê LO·∫†I KH√ÅCH H√ÄNG:')
    Object.entries(stats.demographics.typeDistribution)
      .sort((a, b) => b[1] - a[1])
      .forEach(([type, count]) => {
        const percentage = (count / stats.totalCustomers * 100).toFixed(1)
        console.log(`   üè∑Ô∏è  ${type}: ${count.toLocaleString('vi-VN')} (${percentage}%)`)
      })
  }

  /**
   * Xu·∫•t b√°o c√°o ra file
   */
  exportReport(stats: CustomerStats): void {
    console.log('\nüìù ƒêang xu·∫•t b√°o c√°o...')

    try {
      // T·∫°o th∆∞ m·ª•c n·∫øu ch∆∞a c√≥
      const outputDir = './docs/api'
      if (!existsSync(outputDir)) {
        mkdirSync(outputDir, { recursive: true })
      }

      // T·∫°o b√°o c√°o JSON
      const report = {
        metadata: {
          title: 'Customer Statistics Report - Xu√¢n Th√πy Pet Pharmacy',
          generatedAt: new Date().toISOString(),
          generatedBy: 'Customer Statistics Analyzer v1.0',
          totalCustomersAnalyzed: stats.totalCustomers
        },
        summary: {
          totalCustomers: stats.totalCustomers,
          activeCustomers: stats.activeCustomers,
          activeRate: `${(stats.activeCustomers/stats.totalCustomers*100).toFixed(1)}%`,
          totalRevenue: `${Math.round(stats.totalRevenue).toLocaleString('vi-VN')} VND`,
          averageRevenue: `${Math.round(stats.averageRevenue).toLocaleString('vi-VN')} VND`,
          totalDebt: `${Math.round(stats.totalDebt).toLocaleString('vi-VN')} VND`
        },
        detailedStats: stats,
        rawData: {
          topCustomers: stats.topCustomers,
          customerTypes: this.customerTypes
        }
      }

      const jsonPath = path.join(outputDir, 'customer-statistics-report.json')
      writeFileSync(jsonPath, JSON.stringify(report, null, 2), 'utf-8')

      // T·∫°o b√°o c√°o Markdown
      const markdownReport = `# Customer Statistics Report - Xu√¢n Th√πy Pet Pharmacy

**Generated:** ${new Date().toLocaleString('vi-VN')}  
**Total Customers Analyzed:** ${stats.totalCustomers.toLocaleString('vi-VN')}

## üìä Executive Summary

| Metric | Value |
|--------|-------|
| **Total Customers** | ${stats.totalCustomers.toLocaleString('vi-VN')} |
| **Active Customers** | ${stats.activeCustomers.toLocaleString('vi-VN')} (${(stats.activeCustomers/stats.totalCustomers*100).toFixed(1)}%) |
| **Total Revenue** | ${Math.round(stats.totalRevenue).toLocaleString('vi-VN')} VND |
| **Average Revenue** | ${Math.round(stats.averageRevenue).toLocaleString('vi-VN')} VND |
| **Total Debt** | ${Math.round(stats.totalDebt).toLocaleString('vi-VN')} VND |

## üèÜ Top 10 Customers

${stats.topCustomers.slice(0, 10).map((customer, index) => 
  `${index + 1}. **${customer.customer_name}** (${customer.customer_code}) - ${customer.total_revenue.toLocaleString('vi-VN')} VND`
).join('\n')}

## üìà Revenue Segments

- **No Revenue:** ${stats.revenueSegments.noRevenue.toLocaleString('vi-VN')} (${(stats.revenueSegments.noRevenue/stats.totalCustomers*100).toFixed(1)}%)
- **Low (<1M):** ${stats.revenueSegments.lowRevenue.toLocaleString('vi-VN')} (${(stats.revenueSegments.lowRevenue/stats.totalCustomers*100).toFixed(1)}%)
- **Medium (1M-10M):** ${stats.revenueSegments.mediumRevenue.toLocaleString('vi-VN')} (${(stats.revenueSegments.mediumRevenue/stats.totalCustomers*100).toFixed(1)}%)
- **High (10M-50M):** ${stats.revenueSegments.highRevenue.toLocaleString('vi-VN')} (${(stats.revenueSegments.highRevenue/stats.totalCustomers*100).toFixed(1)}%)
- **VIP (>50M):** ${stats.revenueSegments.vipRevenue.toLocaleString('vi-VN')} (${(stats.revenueSegments.vipRevenue/stats.totalCustomers*100).toFixed(1)}%)

## üìä Data Quality

- **Phone:** ${stats.dataQuality.phoneCompleteness.toFixed(1)}%
- **Email:** ${stats.dataQuality.emailCompleteness.toFixed(1)}%
- **Address:** ${stats.dataQuality.addressCompleteness.toFixed(1)}%
- **Gender:** ${stats.dataQuality.genderCompleteness.toFixed(1)}%

## üìÖ Recent Trends

- **New Customers (30 days):** ${stats.monthlyTrends.newCustomersLast30Days.toLocaleString('vi-VN')}
- **New Customers (90 days):** ${stats.monthlyTrends.newCustomersLast90Days.toLocaleString('vi-VN')}
- **New Customers (1 year):** ${stats.monthlyTrends.newCustomersLast365Days.toLocaleString('vi-VN')}

---
*Report generated automatically by Customer Statistics Analyzer*
`

      const markdownPath = path.join(outputDir, 'CUSTOMER_STATISTICS.md')
      writeFileSync(markdownPath, markdownReport, 'utf-8')

      console.log(`‚úÖ B√°o c√°o JSON: ${jsonPath}`)
      console.log(`‚úÖ B√°o c√°o Markdown: ${markdownPath}`)

    } catch (error) {
      console.error('‚ùå L·ªói khi xu·∫•t b√°o c√°o:', error)
    }
  }

  /**
   * Ch·∫°y to√†n b·ªô ph√¢n t√≠ch
   */
  async runAnalysis(): Promise<void> {
    try {
      console.log('üéØ B·∫ÆT ƒê·∫¶U PH√ÇN T√çCH TH·ªêNG K√ä KH√ÅCH H√ÄNG')
      
      // L·∫•y d·ªØ li·ªáu
      await this.fetchData()
      
      // T√≠nh to√°n th·ªëng k√™
      const stats = this.calculateStats()
      
      // Hi·ªÉn th·ªã k·∫øt qu·∫£
      this.displayStats(stats)
      
      // Xu·∫•t b√°o c√°o
      this.exportReport(stats)
      
      console.log('\n' + '=' .repeat(80))
      console.log('üéâ HO√ÄN TH√ÄNH PH√ÇN T√çCH!')
      console.log(`üìä ƒê√£ ph√¢n t√≠ch ${stats.totalCustomers.toLocaleString('vi-VN')} kh√°ch h√†ng`)
      console.log(`üí∞ T·ªïng doanh thu: ${Math.round(stats.totalRevenue).toLocaleString('vi-VN')} VND`)
      console.log(`üìÅ B√°o c√°o ƒë√£ ƒë∆∞·ª£c l∆∞u t·∫°i: ./docs/api/`)
      console.log('=' .repeat(80))
      
    } catch (error) {
      console.error('\n‚ùå PH√ÇN T√çCH TH·∫§T B·∫†I:', error)
      process.exit(1)
    }
  }
}

// Ch·∫°y ph√¢n t√≠ch
async function main() {
  try {
    const analyzer = new CustomerStatsAnalyzer()
    await analyzer.runAnalysis()
  } catch (error) {
    console.error('‚ùå L·ªói kh·ªüi t·∫°o:', error)
    process.exit(1)
  }
}

// Execute
if (require.main === module) {
  main().catch(console.error)
}

export default CustomerStatsAnalyzer
